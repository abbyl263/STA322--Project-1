---
output:
  pdf_document: default
  html_document: default
---

# STA322 Project 1
## Austin Huang and Abby Li

### Sampling Data

To sample the data, we implemented a stratified sampling method with proportional allocation. 

To start, we found the most up-to-date csv file (Most-Recent-Cohorts-Instition_05192025) from the U.S. Department of Education College Scoreboard site (https://collegescorecard.ed.gov/data/). We decided to create five stratum - private/small, private/medium + large, public/small, public/medium, and public/large. To do this, the first step was to designate which schools were private or public. The variable CONTROL from the original csv file was recoded into a new variable called "type". The variable CONTROL contained 3 levels - 1 indicating public, 2 indicating private nonprofit, and 3 indicating private for profit. The new "type" variable was recoded to contain two levels: public schools (1), and private schools (2 + 3). Next, we categorized the schools as being small, medium, or large. Based on the UGDS variable, indicating undergraduate enrollment, schools were considered small if there is less than 2,000 enrolled, they were considered medium if the enrollment is between 2,000-10,000, and they were considered large if enrollment is over 10,000. These thresholds were created based on the size categories from the website. Additionally, we decided to combine the strata for private schools to include both large and medium institutions because there are only ~20 schools that are considered large private schools. This allows us to avoid very small stratum sample sizes when implementing proportional allocation, which can help improve the stabiliity of variance estimates. Overall, we chose to use these 5 stratums to create groups based on similar characteristics of type and size with the goal of reducing variance within stratums, but also maintaining differences between stratums. 


```{r}
library(dplyr)
library(tidyr)
library(survey)

colleges <- read.csv("colleges.csv")
```

```{r}

colleges_q1 <-  colleges %>%
  select(INSTNM, UGDS, CONTROL, CIP27BACHL, MD_EARN_WNE_5YR, TUITIONFEE_IN) %>%
  mutate (type = case_when(
    CONTROL == 1 ~ "Public",
    CONTROL %in% c(2, 3) ~"Private",
    TRUE ~ NA_character_
  )) %>%
  mutate(size = case_when(
    UGDS > 15000 ~ "Large",
    UGDS >= 2000 & UGDS <= 15000 ~ "Medium",
    UGDS < 2000 ~ "Small",
    TRUE ~ NA_character_  
  ))

# creating the six strata 
colleges_q1 <- colleges_q1 %>%
  mutate(stratum = case_when(
    type == "Public" & size == "Large"  ~ "Public-Large",
    type == "Public" & size == "Medium" ~ "Public-Medium",
    type == "Public" & size == "Small"  ~ "Public-Small",
    type == "Private" & size == "Small" ~ "Private-Small",
    type == "Private" & size %in% c("Medium","Large")~ "Private-Medium/Large",
    TRUE ~ NA_character_
  ))

colleges_q1 <- colleges_q1 %>% 
  drop_na()

```

```{r}
# sample with proportional allocation

N_total <- nrow(colleges_q1)
n_total <- 100

set.seed(322)

# ---------- 1) Compute stratum population sizes N_h ----------
stratum_info <- colleges_q1 %>% 
  group_by(stratum) %>% 
  summarise(N_h = n()) %>% 
  ungroup()

# ---------- 2) Proportional allocation: raw n_h ----------
stratum_info <- stratum_info %>% 
  mutate(n_h_raw = n_total * (N_h / sum(N_h)))

# ---------- 3) Round n_h to integers while ensuring sum = n_total ----------
# simple strategy: floor then distribute remainder to strata with largest fractional parts
stratum_info <- stratum_info %>% 
  mutate(n_floor = floor(n_h_raw),
         frac = n_h_raw - n_floor)

remainder <- n_total - sum(stratum_info$n_floor)
if (remainder > 0) {
  # give +1 to the strata with largest fractional parts
  add_idx <- order(stratum_info$frac, decreasing = TRUE)[1:remainder]
  stratum_info$n_final <- stratum_info$n_floor
  stratum_info$n_final[add_idx] <- stratum_info$n_final[add_idx] + 1
} else {
  stratum_info$n_final <- stratum_info$n_floor
}

# If any n_final == 0 (small strata), enforce a minimum of 1:
min_per_stratum <- 1
zeros <- which(stratum_info$n_final < min_per_stratum)
if(length(zeros)>0){
  for(i in zeros) stratum_info$n_final[i] <- min_per_stratum
  # reduce from the largest strata to keep sum == n_total
  while(sum(stratum_info$n_final) > n_total){
    # pick stratum with largest n_final to decrement (but keep >= min)
    idx <- which.max(stratum_info$n_final)
    if(stratum_info$n_final[idx] > min_per_stratum) stratum_info$n_final[idx] <- stratum_info$n_final[idx] - 1
    else break
  }
}
# check
stopifnot(sum(stratum_info$n_final) == n_total)


# ---------- 4) Join n_h back to frame and sample ----------
colleges_df <- colleges_q1 %>% left_join(stratum_info %>% select(stratum, N_h, n_final), by = "stratum")
names(colleges_df)[names(colleges_df) == "n_final"] <- "n_h"

# draw SRS without replacement within each stratum
sampled <- colleges_df %>%
  group_by(stratum) %>%
  sample_n(size = unique(n_h)) %>%
  ungroup()

# ---------- 5) Compute design weights ----------
# For SRS within stratum, inclusion prob pi = n_h / N_h, so weight = 1/pi = N_h / n_h
sampled <- sampled %>%
  mutate(pi = n_h / N_h,
         weight = N_h / n_h)
```

### Question 1
What is an estimate of the total number of undergraduate students enrolled in colleges? Design your survey with the goal of answering this question most accurately. 

```{r}
des <- svydesign(id = ~1, strata = ~stratum, weights = ~weight, fpc = ~N_h, data = sampled)

total_undergrads <- svytotal(~UGDS, des)
total_undergrads
confint(total_undergrads)
```
The total number of undergraduate students enrolled in college is 13,056,855 with a standard error of 1,157,820. We are 95% confident that the true total number of undergraduates is between 10,787,569 and 15,326,140. 

### Question 2
What fraction of colleges have a major in statistical science? Use your sample to estimate this fraction; do not get the answer by filtering the schools. 

### Question 3
What is the average of the median earnings among alumni from public schools? From private schools? (combine for profit and not for profit private schools)

```{r}
avg_median_earnings <- svyby(~MD_EARN_WNE_5YR, ~type, des, svymean, na.rm = TRUE)
avg_median_earnings
confint(avg_median_earnings)
```
To answer this question, we will be using the MD_EARN_WNE_5YR variable. This variable indicates the median earnings 5 years after graduation, which is a good time metric since the question is focused on alumni specifically (https://collegescorecard.ed.gov/files/InstitutionDataDocumentation.pdf). 

The average of the median earnings among alumni 5 years after completion of private colleges is 48267.42 with a standard error of 2303.50. The average of the median earnings among alumni 5 years after completion of public colleges is 49500.21 with a standard error of 1286.48.
The 95% confidence interval for median earnings for private school alum is between 43,752 and 52,782. The 95% confidence interval for median earnings for public school alum is between 46,978 and 52,021. 

### Question 4
What is the average of the tuition for in-state students from public schools? From private schools? (combine for profit and not for profit private schools)

```{r}
avg_median_debt <- svyby(~TUITIONFEE_IN, ~type, des, svymean, na.rm = TRUE)
avg_median_debt
confint(avg_median_debt)
```

To answer this question, we will be using the TUITIONFEE_IN variable. This variable indicates the tuition and required fees that are for in-state students (https://collegescorecard.ed.gov/files/InstitutionDataDocumentation.pdf) 

The average of tuition for in-state students in private colleges is 28,834 with a standrad error of 2017. The average tuition for in-state students in public colleges is 5,990 with a standard error of 491. 
The 95% CI for average tuition of in-state students in private colleges is between 24880 and 32788. The 95% CI for average tuition of in-state students in public colleges is between 5026 and 6955. 
This makes sense private colleges usually charge both in-state and out-state students the same tuition, whereas those living in-state and attending public colleges are usually charged significantly less. 

